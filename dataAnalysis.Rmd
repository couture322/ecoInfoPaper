---
title: "EVOSTC data collection paper - Analysis"
author: "Jessica Couture"
date: "5/31/2016"# started: "9/27/2015"
output: html_document
---

#Background

We are writing up a publication to report results of a two year data archiving effort by a small group of researchers and students at the National Center for Ecological Analysis and Synthesis at UC Santa Barbara. The [Exxon Valdez Oil Spill Trustee Council](http://www.evostc.state.ak.us) (EVOSTC) was formed following the Exon Valdez oil spill in Alaska in 1989. Since then, the EVOSTC has funded hundreds of projects and in 2012 we initiated an effort to recover and archive the data collected in these EVOSTC funded projects.

For this paper we ask 4 main questions about the data collected from the Exxon Valdez Oil Spill Trustee Council funded projects:

1. Twenty-five years after the EVOS, for how many projects funded by EVOSTC can we collect data?
2. Are there certain **research fields** that are more likely to make data available than others?
3. Are there certain **sectors** that are more likely to make data available than others?
4. Is the availability of data correlated to how old the data are? (temporal relationships?)


```{r data prep,echo=FALSE,message=FALSE}

library(knitr)
library(dplyr)
library(readr)
library(ggplot2)
library(reshape2)
library(grid)
library(gridExtra)
library(party)

rslt=read.csv('data/archResRevised2.csv',header=T,stringsAsFactors=T)
rslt[rslt$Status=='published','Status']<-'Published'

rslt$succ=ifelse(rslt$Status %in% c('Published','SentData','Revised'),0,1) # 0=success???
rslt$statSucc=ifelse(rslt$Status %in% c('Published','SentData','Revised'),1,0) # 1 = success, 2 = not successful


agDes=read.csv('data/ecoInfoAgencyDesig.csv',header=T,stringsAsFactors=T,col.names=c('agency','agGrp','agSubGrp'))
agDes$agGrp=gsub('nonProf','private',agDes$agGrp)


rslt2=merge(rslt,agDes,all.x=T)
rslt2=rslt2 %>%
  filter(!end>2010) %>%
  select(Status,start,end,ecosystem,dataType,statSucc,agGrp,agSubGrp,reason)

splBio=strsplit(as.character(rslt2$dataType),'-')
rslt3<-rslt2 %>%
  mutate(dtGen=sapply(splBio,function(x) as.factor(x[1])))

head(rslt3)
```

# 1. Project Status Reporting
<h4>Twenty-five years after the EVOS, for how many projects funded by EVOSTC can we collect data?</h4>
 


### Test for equal proportions between status categories:
Are the proportion of projects in each category equal? --> chi-squared test


Limitations of the Chi-Square Test: 

* The chi-square test does not give us much information about the strength of the relationship or its substantive significance in the population.
* The chi-square test is sensitive to sample size. The size of the calculated chi-square is directly proportional to the size of the sample, independent of the strength of the relationship between the variables.
* The chi-square test is also sensitive to small expected frequencies in one or more of the cells in the table. 

I feel like these are things that we have always been aware of and in our don't create any false significance...opinions? Social data?

```{r chi squared - test for eq prop,echo=FALSE}
statusProps=table(rslt2$Status)
eqProp=chisq.test(statusProps) #not equal proportions

eqProp
```
__Proportions are NOT equal between status groups__

***

# Chi-square tests for each group

### 1. Data type category

### Are there certain **research fields** that are more likely to make data available than others?

### Test for equal proportions between categories:

Chi-squared test for equal proportions between research fields funded

```{r chi squared - field of study,echo=FALSE,warning=FALSE}

dtProps=table(rslt3$statSucc,rslt3$dtGen)
dtChi=chisq.test(dtProps)

dtChi
```

Chi-squared test for equal proportions between research fields - _bio broken out_

```{r chi squared - field of study BIO,echo=FALSE,warning=FALSE}

bioProps=table(rslt2$statSucc,rslt2$dataType)
bioChi=chisq.test(bioProps)

bioChi
```

***

### 2. Research sector type

### Are there certain **sectors** that are more likely to make data available than others?
(based on PI's affiliation)

#### Test for equal propportions between PI's home institution type/sector: 

government and private grouped
```{r chi squared - sector,echo=FALSE,warning=FALSE}
secProps=table(rslt2$statSucc,rslt2$agGrp)
sectChi=chisq.test(secProps)

sectChi
```

#### Test for equal propportions between PI's home institution type/sector:

government and private split: govFed, govState, nonProf, forProf
```{r chi squared - subSector,echo=FALSE,warning=FALSE}
subSecProps=table(rslt2$statSucc,rslt2$agSubGrp)
subSectChi=chisq.test(subSecProps)

subSectChi
```
__NOT SIGNIFICANT: neither sectors nor subsectors are significant__

***

### 3. Temporal relationships

### Is the availability of data correlated to how old the data are?

#### Test for equal proportions between categories:

Chi-squared test for equal proportions between age of data

```{r chi squared - end years,echo=FALSE,warning=FALSE}

tempProps=table(rslt2$statSucc,as.character(rslt2$end))
tempChi=chisq.test(tempProps)

tempChi
```

***

### Binomial logistic regression: ALL data
Which elements contribute most in determining if the data will be successfully collected?
Groups tested:

* research field
  + levels: biological, chemical, modeling, oil, physical, social 
  + levels: biological-benthicInverts, biological-birds, biological-fish, biological-habitat, biological-mammals, biological-plankton, chemical, physical, oil, modeling
* research sector of project PI
  + levels: academia, govFed, govState, nonProf, forProf, tribe
* year project recieved its last year of EVOSTC funding
  + continuous variable

## Binomial logistic model: dummy variables

#### _General data types_

```{r BLM - allGen}

succBlrGen<-glm(formula = statSucc~agSubGrp+end+dtGen,family='binomial',data=rslt3)

## statSucc = Binomial: did we recover the data?
## agGrp = sector of home institution
## end = last year project was funded by EVOSTC
## dtgeb = general field of study (bio grouped)

summary(succBlrGen)

```

#### _Biological data types defined_

```{r BLM - allBioSep}

succBlrBio<-glm(formula = statSucc~agSubGrp+end+dataType,family='binomial',data=rslt3)

## statSucc = Binomial: did we recover the data?
## agGrp = sector of home institution
## end = last year project was funded by EVOSTC
## dataType = field of study (bio ungrouped)

summary(succBlrBio)

```
__Only categories with low success rates are sginificant ("low"" is <20%): fish data and social data__

Potential explanations:

* Fish: Culture around protecting fishing locations and catches
* Social: formats of data collection and storage diffcult to share

__THESE RESULTS CHANGE WHEN I CHANGE THE ORDER OF FACTORS__

***

## Binomial logistic model: deviation coding

Some notes on this technique: This method compares each level to the mean of the group. This still results in the issue we were having in which it cuts off the last level since its assumed you can calculate it from the rest of the results. The _estimate_ can be calculated in this way but as I read: ["So far I could not find a way to assess the significance of the difference between the overall mean and the last groupâ€¦"](https://www.r-bloggers.com/using-and-interpreting-different-contrasts-in-linear-models-in-r/) Anyone know a way around this? Re-order the levels?

#### _General data types_

```{r BLMdevCode - allGen}


contrasts(rslt3$dtGen) = contr.sum(5)
contrasts(rslt3$agSubGrp) = contr.sum(6)

succBlrGen<-glm(formula = statSucc~agSubGrp+end+dtGen,family='binomial',data=rslt3)

## statSucc = Binomial: did we recover the data?
## agGrp = sector of home institution
## end = last year project was funded by EVOSTC
## dtgeb = general field of study (bio grouped)

summary(succBlrGen)

```

#### _Biological data types defined_

```{r BLMdevCode - allBioSep}

contrasts(rslt3$dataType) = contr.sum(10)

succBlrBio<-glm(formula = statSucc~agSubGrp+end+dataType,family='binomial',data=rslt3)

## statSucc = Binomial: did we recover the data?
## agGrp = sector of home institution
## end = last year project was funded by EVOSTC
## dataType = field of study (bio ungrouped)

summary(succBlrBio)

```
__Nothing is significant__

The results don't change if I change the order of the levels

***

## Trees & forests

I use the "party" package in R to create a decision tree using the same model as the glm, then calculate importance of each variable using the cforest function in the party package. This package is be better than randomForest when independent variables are different types (Strobl et al. 2009)

#### _General data types_

##### Classification tree

```{r class tree, message=F}

partree<-ctree(statSucc~agSubGrp+end+dtGen,data=rslt3)

partree

plot(partree)
```

##### Random Forests
```{r randForest, message=F}
partyFor<-cforest(statSucc~agSubGrp+end+dtGen,data=rslt3,controls = cforest_unbiased(mtry = 2, ntree = 1000))
varimp(partyFor)
```

#### _Biological data types defined_

##### Classification tree

```{r class tree bio, message=F}
rm(partree)
partreeBio<-ctree(statSucc~agSubGrp+end+dataType,data=rslt3)

partreeBio

plot(partreeBio)
```

##### Random forests
```{r randForestBio, message=F}
partyForBio<-cforest(statSucc~agSubGrp+end+dataType,data=rslt3,controls = cforest_unbiased(mtry = 2, ntree = 1000))
varimp(partyForBio)
```