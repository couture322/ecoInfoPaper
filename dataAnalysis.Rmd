---
title: "EVOSTC data collection paper - Analysis"
author: "Jessica Couture"
date: "9/6/2016"# started: "9/27/2015"
output: 
  html_document:
    toc: true
    toc_depth: 3
---

## Background

We are writing up a publication to report results of a two year data archiving effort by a small group of researchers and students at the National Center for Ecological Analysis and Synthesis at UC Santa Barbara. The [Exxon Valdez Oil Spill Trustee Council](http://www.evostc.state.ak.us) (EVOSTC) was formed following the Exxon Valdez oil spill in Alaska in 1989. Since then, the EVOSTC has funded hundreds of projects and in 2012 we initiated an effort to recover and archive the data collected in these EVOSTC funded projects which lasted for two years.

For this paper we ask 4 main questions about the data collected from the Exxon Valdez Oil Spill Trustee Council funded projects:

1. Twenty-five years after the EVOS, for how many projects funded by EVOSTC can we collect data?
2. Are there differences in data reporting based on data characteristics?

  * Research field
  * Sector of researching body
  * Year data projects ended

3. Which characteristics are most *important* in determining if a dataset will be successfully recovered?
4. How do the important characteristics influence the output (success)?


```{r data prep,echo=FALSE,message=FALSE,warning=F}

library(knitr)
library(dplyr)
library(readr)
library(ggplot2)
library(reshape2)
library(grid)
library(gridExtra)
library(party)

rslt=read.csv('data/archResRevised2.csv',header=T,stringsAsFactors=T)
rslt[rslt$Status=='published','Status']<-'Published'

rslt$succ=ifelse(rslt$Status %in% c('Published','SentData','Revised'),0,1) # 0=success??? ### RM?
rslt$statSucc=ifelse(rslt$Status %in% c('Published','SentData','Revised'),1,0) # 1 = success, 2 = not successful


agDes=read.csv('data/ecoInfoAgencyDesig.csv',header=T,stringsAsFactors=T,col.names=c('agency','agGrp','agSubGrp'))
agDes$agGrp=gsub('nonProf','private',agDes$agGrp)


rslt2=merge(rslt,agDes,all.x=T)
rslt2=rslt2 %>%
  filter(!end>2010) %>%
  select(Status,start,end,ecosystem,dataType,statSucc,agGrp,agSubGrp,reason)

splBio=strsplit(as.character(rslt2$dataType),'-')

rslt2$dataType<-gsub("biological-",'',rslt2$dataType)

```

## 1. Project Status Reporting
<h4>Twenty-five years after the EVOS, for how many projects funded by EVOSTC can we collect data?</h4>
 
```{r status plot, fig.width=10,echo=FALSE}

overall=table(rslt2$Status)
overallLong=melt(overall)
colnames(overallLong)=c('Status','nDatasets')
overall2=overallLong %>%
  mutate(prop=nDatasets/sum(nDatasets))

possible=overallLong %>%
  filter(!Status=='Unrecoverable') %>%
  mutate(prop=nDatasets/sum(nDatasets))

statusOrd=c('Unrecoverable','Emailed','Replied','SentData','Revised','Published')
#rslt2$Status=as.factor(rslt2$Status,levels=statusOrd,ordered=T)
statGrey=c('Unrecoverable'='gray67',
             'Emailed'='gray67',
             'Replied'='gray67',
             'SentData'='black',
             'Revised'='black',
             'Published'='black')

statPlot=ggplot()+
  geom_bar(data=rslt2,
                 aes(x=factor(Status,levels=statusOrd,ordered=T),fill=Status))+
  scale_fill_manual(labels=statusOrd,breaks=statusOrd,values=statGrey)+
  theme(legend.title=element_blank())+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  #theme(axis.text.x = element_text(angle=90))+
  xlab(expression(RecoveryStage %->% .))+ # %->%, symbol(/256)
  ylab('Number of projects\n')+
  ggtitle('Projects status')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"),
        legend.text = element_text(size = 14, face = "bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))

statPlot

```

```{r Effort results}
# Number of projects requested
sum(overall)

# percent successful
sum(overall[c("Published","SentData")])/sum(overall)
```

***

## 2. Are there differences in data reporting based on data characteristics?
#### Chi-square tests for each variable (characteristic)

Limitations of the Chi-Square Test: 

* The chi-square test does not give us much information about the strength of the relationship or its substantive significance in the population.
* The chi-square test is sensitive to sample size. The size of the calculated chi-square is directly proportional to the size of the sample, independent of the strength of the relationship between the variables.
* The chi-square test is also sensitive to small expected frequencies in one or more of the cells in the table. 

I feel like these are things that we have always been aware of and in our don't create any false significance...opinions? Social data?

### Research field

#### Are there certain **research fields** that are more likely to make data available than others?

Chi-squared test for equal proportions between research fields - _bio broken out_

```{r chi squared - field of study BIO,echo=FALSE,warning=FALSE}

bioProps=table(rslt2$statSucc,rslt2$dataType)
bioChi=chisq.test(bioProps)

bioChi
```
__SIGNIFICANT: There are differences between successes in different research fields__

***

### Research sector

#### Test for equal propportions between PI's home institution type/sector:

government and private split: govFed, govState, nonProf, forProf
```{r chi squared - subSector,echo=FALSE,warning=FALSE}
subSecProps=table(rslt2$statSucc,rslt2$agSubGrp)
subSectChi=chisq.test(subSecProps)

subSectChi
```
__NOT SIGNIFICANT: sectors are not significant__

***

### Year project ended

#### Test for equal proportions between years:

Chi-squared test for equal proportions between age of data

```{r chi squared - end years,echo=FALSE,warning=FALSE}

tempProps=table(rslt2$statSucc,as.character(rslt2$end))
tempChi=chisq.test(tempProps)

tempChi

```
__NOT SIGNIFICANT: no detectable temporal trends in reporting data__

***
## 3. Which characteristics are most important in determining if a dataset will be successfully recovered?

I use the "party" package in R to run a random forests analysis to determine which variables are most important (cforet() function). I use the same model as the glm, then create a classification tree below to show how the important variables influence the outcome. This package is be better than randomForest when independent variables are different types (Strobl et al. 2009)

### Random forests
```{r randForestBio, message=F}
partyForBio<-cforest(statSucc~agSubGrp+end+dataType,data=rslt2,controls = cforest_unbiased(mtry = 2, ntree = 1000))
varimp(partyForBio)
```

__Since the importance value for research field is so much higher than the others, the most important variable in determining the outcome is research field__
We would also like to discuss in the discussion that temporal relationships are _almost_ siginficantly different (chi-sq above), and although much less important, still recognized in this analysis. So we may have ghosts of the Michner theory even if our data aren't strong/clean enough to completely pull out the significance.

***

## 4. How do the important characteristics influence the output (success)? 
### Classification tree

```{r class tree bio, message=F, warning=FALSE}
partreeBio<-ctree(statSucc~agSubGrp+end+dataType,data=rslt2)

partreeBio

plot(partreeBio)
```

