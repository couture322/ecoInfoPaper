---
title: "EVOSTC data collection paper - Analysis"
author: "Jessica Couture"
date: "5/31/2016"# started: "9/27/2015"
output: html_document
---

#Background

We are writing up a publication to report results of a two year data archiving effort by a small group of researchers and students at the National Center for Ecological Analysis and Synthesis at UC Santa Barbara. The [Exxon Valdez Oil Spill Trustee Council](http://www.evostc.state.ak.us) (EVOSTC) was formed following the Exon Valdez oil spill in Alaska in 1989. Since then, the EVOSTC has funded hundreds of projects and in 2012 we initiated an effort to recover and archive the data collected in these EVOSTC funded projects.

For this paper we ask 4 main questions about the data collected from the Exxon Valdez Oil Spill Trustee Council funded projects:

1. Twenty-five years after the EVOS, for how many projects funded by EVOSTC can we collect data?
2. Are there certain **research fields** that are more likely to make data available than others?
3. Are there certain **sectors** that are more likely to make data available than others?
4. Is the availability of data correlated to how old the data are? (temporal relationships?)


```{r data prep,echo=FALSE,message=FALSE}

library(knitr)
library(dplyr)
library(readr)
library(ggplot2)
library(reshape2)
library(grid)
library(gridExtra)

rslt=read.csv('data/archResRevised2.csv',header=T,stringsAsFactors=F)
rslt[rslt$Status=='published','Status']<-'Published'

rslt$succ=ifelse(rslt$Status %in% c('Published','SentData','Revised'),0,1)
rslt$statSucc=ifelse(rslt$Status %in% c('Published','SentData','Revised'),1,2) # 1 = success, 2 = not successful


agDes=read.csv('data/ecoInfoAgencyDesig.csv',header=T,stringsAsFactors=T,col.names=c('agency','agGrp','agSubGrp'))
agDes$agGrp=gsub('nonProf','private',agDes$agGrp)


rslt2=merge(rslt,agDes,all.x=T)
rslt2=rslt2 %>%
  filter(!end>2010) 
```
Data table="rslt2"

```{r colorSetup, echo=F}
statusCols=c('Unrecoverable'='orangered',
             'Emailed'='orange',
             'Replied'='gold',
             'SentData'='darkolivegreen2',
             'Revised'='darkolivegreen3',
             'Published'='forestgreen')

succCols=c('aff'='grey17',
           'neg'='grey89')

```

# 1. Comparison with other studies:

This is one of four studies I found that look at the ability to recover data that is supposed to be publicly available

```{r comparison data, echo=FALSE}
comp=data.frame(study=c('SavageVickers2009','WichertsEtAl2006','Wolins1962','evostcProject2012'),
                n=c(10,249,37,nrow(rslt2)),
                successRate=c(0.10,0.26,0.24,
                              nrow(rslt2[rslt2$succ==0,])/nrow(rslt2)))
comp

stComparison<-ggplot(comp,aes(x=study,y=successRate))+
  geom_bar(stat = "identity")+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  xlab('\nStudy')+
  ylim(0,0.5)+
  ylab('% successful\n')+
  ggtitle('Success rates from four data recovery studies')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))+
  annotate("text",x=1,y=comp$successRate[4]+0.05,label=as.character(comp$n[4]))+
  annotate("text",x=2,y=comp$successRate[1]+0.05,label=as.character(comp$n[1]))+
  annotate("text",x=3,y=comp$successRate[2]+0.05,label=as.character(comp$n[2]))+
  annotate("text",x=4,y=comp$successRate[3]+0.05,label=as.character(comp$n[3]))
stComparison
```



# 2. Project Status Reporting
<h4>Twenty-five years after the EVOS, for how many projects funded by EVOSTC can we collect data?</h4>
 


### Test for equal proportions between status categories:
Are the proportion of projects in each category equal?
```{r chi squared - test for eq prop,echo=FALSE}
statusProps=table(rslt2$Status)
eqProp=chisq.test(statusProps) #not equal proportions

eqProp
```
__Proportions are NOT equal between status groups__

### Plot status of datasets at the end of the initial archiving effort:
```{r status plot,echo=FALSE}
overall=table(rslt2$Status)
overallLong=melt(overall)
colnames(overallLong)=c('Status','nDatasets')
overall2=overallLong %>%
  mutate(prop=nDatasets/sum(nDatasets))

possible=overallLong %>%
  filter(!Status=='Unrecoverable') %>%
  mutate(prop=nDatasets/sum(nDatasets))

statusOrd=c('Unrecoverable','Emailed','Replied','SentData','Revised','Published')

statPlot=ggplot()+
  geom_bar(data=rslt2,
                 aes(x=factor(Status,levels=statusOrd,ordered=T),fill=Status))+
  scale_fill_manual(labels=statusOrd,values=statusCols,breaks=statusOrd)+
  theme(legend.title=element_blank())+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  xlab('Status')+
  ylab('Number of Projects\n')+
  ggtitle('Dataset status distribution')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"),
        legend.text = element_text(size = 14, face = "bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))

statPlot

```

### Binomial logistic regression: ALL data
Which elements contribute most in determining if the data will be successfully collected?
* research field
* research sector of project PI
* year project was last funded
```{r BLM - all}

succBlr<-glm(formula = succ~agSubGrp+end+dataType,family='binomial',data=rslt2)

## statSucc = Binomial: did we recover the data?
## agGrp = sector of home institution
## end = last year project was funded by EVOSTC
## dataType = field of study

summary(succBlr)

```
__Only categories with low success rates are sginificant (if "low"" is <20%): fish data and social data__

Potential explanations:

* Fish: Culture around protecting fishing locations and catches
* Social: formats of data collection and storage diffcult to share

---

# 3.Data type category
### Are there certain **research fields** that are more likely to make data available than others?

### Test for equal proportions between categories:

Chi-squared test for equal proportions between research fields funded

```{r chi squared - field of study,echo=FALSE}

dtProps=table(rslt2$succ,rslt2$dataType)
dtChi=chisq.test(dtProps)

dtChi
```

### Binomial logistic regression: Research field
Which elements contribute most in determining if the data will be successfully collected?
Since the chi-square test p-vaule << 0.05, run a binomial logistic regression to pull out where the differences occur
```{r dataType BLR,echo=FALSE}
dtBlr<-glm(formula = succ~dataType,family='binomial',data=rslt2)

summary(dtBlr)
```
__similar to above: fish, eco/hab and social are significant because they are so low__

### PLOT: Successes by data type
```{r research field success plot,echo=FALSE}



```

---

# 4. Research sector type
### Are there certain **sectors** that are more likely to make data available than others?
(based on PI's affiliation)
### Test for equal propportions between PI's home institution type/sector:
```{r chi squared - sector,echo=FALSE}
secProps=table(rslt2$succ,rslt2$agGrp)
sectChi=chisq.test(secProps)

sectChi

subSecProps=table(rslt2$succ,rslt2$agSubGrp)
subSectChi=chisq.test(subSecProps)

subSectChi
```
__NOT SIGNIFICANT: neither sectors nor subsectors are significant__

### PLOT: Success by sector

``` {r sector success plot,echo=FALSE}

secSubYN=as.data.frame(table(rslt2$agSubGrp,rslt2$succ))
colnames(secSubYN)=c('subSector','succ','nDatasets')

secSubYN2=secSubYN %>%
  group_by(subSector) %>%
  mutate(prop=nDatasets/sum(nDatasets))
secSubYN2$subSector=factor(secSubYN2$subSector,levels=c("gov_fed","gov_state","academia","nonProf","private","tribe"),ordered = T)

subSecNds=ggplot(secSubYN2,aes(x=subSector,y=nDatasets))+
  geom_bar(stat = "identity",fill="grey")+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())+
  ylab('Number of Projects\n')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))

subSecPerc=ggplot(secSubYN2[secSubYN2$succ==0,],aes(x=subSector,y=as.numeric(prop*100)))+
  geom_bar(stat = "identity",fill="black")+
  scale_x_discrete(breaks=levels(secSubYN2$subSector),
                   labels=c("govFed","govState","academia","nonProfit","forProfit","tribes"))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(angle=90))+
  xlab('Sector')+
  ylab('% successful\n')+
  ylim(0,75)+
  #ggtitle('Percent success by research sector type')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))

grid.arrange(subSecNds, subSecPerc, ncol = 1, heights=c(1,1.75))

```

---

# 5. Temporal relationships
### Is the availability of data correlated to how old the data are?

### Plot of data reporting based on the last year the data project was funded to represent length of time since data were produced
```{r temporal-endYr}


```


# 6. Why don't people share data?

```{r whyNot, echo=F}
reas=rslt2 %>%
  filter(Status=='Unrecoverable') %>%
  filter(!reason=="no data generated") %>%
  filter(!reason=="data uvailable") %>%
  select(Status,reason)
reasTab=as.data.frame(table(reas$reason))
colnames(reasTab)=c('reason','nDatasets')

## add in status = 'emailed' to 'no contact info' & status = "replied" to unwilling to share? ...discuss with group

reasTab[reasTab$reason=='no contact info',"nDatasets"] <- (reasTab[reasTab$reason=='no contact info',"nDatasets"] + length(rslt2[rslt2$Status=='Emailed','Status'])) 

levels(reasTab$reason)=c(levels(reasTab$reason),'communication lost')

reasTab[6,]<-c('communication lost', length(rslt2[rslt2$Status=='Replied','Status'])+1)# +1 for one of the 'data unavailable' datasets, add the other to "data lost"
reasTab[1,2]<-as.numeric(as.character(reasTab[reasTab$reason=="data lost","nDatasets"]))+1

reasTab<-arrange(reasTab,desc(as.numeric(nDatasets)))
reasTab$reason<-factor(reasTab$reason,levels = reasTab$reason,ordered = T)

whyNot<-ggplot(reasTab,aes(x=reason,y=as.numeric(nDatasets)))+
  geom_bar(stat = "identity")+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #xlab('\nReason data were not recovered')+
  ylab('Number of Projects\n')+
  #ggtitle('Why are data not recovered?')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) ## *** add each n as text above bar
whyNot
```

