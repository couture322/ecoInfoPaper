---
title: "EVOSTC data collection paper - Data Visualizations"
author: "Jessica Couture"
date: "5/25/2016"
output: html_document
---

#Background

We are writing up a publication to report results of a two year data archiving effort by a small group of researchers and students at the National Center for Ecological Analysis and Synthesis at UC Santa Barbara. The [Exxon Valdez Oil Spill Trustee Council](http://www.evostc.state.ak.us) (EVOSTC) was formed following the Exon Valdez oil spill in Alaska in 1989. Since then, the EVOSTC has funded hundreds of projects and in 2012 we began a project to recover and archive the data collected in these EVOSTC funded projects.

For this paper we ask 4 main questions about the data collected from the Exxon Valdez Oil Spill Trustee Council funded projects:

1. How did our overall success rate compare against other similar studies?
2. Twenty-five years after the EVOS, for how many projects funded by EVOSTC can we collect data?
3. Are there certain **research fields** that are more likely to make data available than others?
4. Are there certain **sectors** that are more likely to make data available than others?
5. Is the availability of data correlated to how old the data are? (temporal relationships?)
6.Why did people refuse to share their data?

## Statistics:
So far the plan is to run both Chi-squared and Binomial Logistic Regression. Chi-sq will test for differences in reporting between these different slices of data and if there are differences, the BLM will help ID which are the most important indicators of success amongst the groups. I ran this on an early set of data and plan to re-run this weekend.

If anyone has experience with binomial data and can suggest other tests we're all ears!

***

```{r data prep,echo=FALSE,message=FALSE}

library(knitr)
library(dplyr)
library(readr)
library(ggplot2)
library(reshape2)
library(grid)
library(gridExtra)
library(gtable)

rslt=read.csv('data/archResRevised2.csv',header=T,stringsAsFactors=F)
rslt[rslt$Status=='published','Status']<-'Published'

rslt$succ=ifelse(rslt$Status %in% c('Published','SentData','Revised'),0,1)
rslt$statSucc=ifelse(rslt$Status %in% c('Published','SentData','Revised'),1,2) # 1 = success, 2 = not successful

agDes=read.csv('data/ecoInfoAgencyDesig.csv',header=T,stringsAsFactors=T,col.names=c('agency','agGrp','agSubGrp'))
agDes$agGrp=gsub('nonProf','private',agDes$agGrp)

rslt2=merge(rslt,agDes,all.x=T)
rslt2=rslt2 %>%
  filter(!end>2010) 
```

## Plots:

```{r, echo=F}
statusCols=c('Unrecoverable'='orangered',
             'Emailed'='orange',
             'Replied'='gold',
             'SentData'='darkolivegreen2',
             'Revised'='darkolivegreen3',
             'Published'='forestgreen')

```

***

### 1. Comparison with other studies:

> How do our results compare to other data recovery efforts/studies?

This is one of four studies I found that look at the ability to recover data that is supposed to be publicly available.

```{r comparison data, echo=FALSE}

comp=data.frame(study=c('SavageVickers2009','WichertsEtAl2006','Wolins1962','evostcProject2012'),
                n=c(10,249,37,nrow(rslt2)),
                successRate=c(0.10,0.26,0.24,
                              nrow(rslt2[rslt2$succ==0,])/nrow(rslt2)))
comp

stComparison<-ggplot(comp,aes(x=study,y=successRate))+
  geom_bar(stat = "identity")+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  xlab('\nStudy')+
  ylim(0,0.5)+
  ylab('% successful\n')+
  ggtitle('Success rates from four data recovery studies')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))+
  annotate("text",x=1,y=comp$successRate[4]+0.05,label=as.character(comp$n[4]))+
  annotate("text",x=2,y=comp$successRate[1]+0.05,label=as.character(comp$n[1]))+
  annotate("text",x=3,y=comp$successRate[2]+0.05,label=as.character(comp$n[2]))+
  annotate("text",x=4,y=comp$successRate[3]+0.05,label=as.character(comp$n[3]))
stComparison
```

***

# 2. Project Status Reporting
> Twenty-five years after the EVOS, for how many projects funded by EVOSTC can we collect data?</h4>

For this first question, we should use the original plot generated from redmine that simply displays the number of datasets in each staus at the end to the 2 year data collection effort

```{r status plot, fig.width=10,echo=FALSE}

overall=table(rslt2$Status)
overallLong=melt(overall)
colnames(overallLong)=c('Status','nDatasets')
overall2=overallLong %>%
  mutate(prop=nDatasets/sum(nDatasets))

possible=overallLong %>%
  filter(!Status=='Unrecoverable') %>%
  mutate(prop=nDatasets/sum(nDatasets))

statusOrd=c('Unrecoverable','Emailed','Replied','SentData','Revised','Published')
#rslt2$Status=as.factor(rslt2$Status,levels=statusOrd,ordered=T)

statPlot=ggplot()+
  geom_bar(data=rslt2,
                 aes(x=factor(Status,levels=statusOrd,ordered=T),fill=Status))+
  scale_fill_manual(labels=statusOrd,values=statusCols,breaks=statusOrd)+
  theme(legend.title=element_blank())+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  #theme(axis.text.x = element_text(angle=90))+
  xlab('Status')+
  ylab('Number of Projects\n')+
  ggtitle('Dataset status distribution')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"),
        legend.text = element_text(size = 14, face = "bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))

statPlot

```

***

# 3.Research field
> Are there certain **research fields** that are more likely to make data available than others?
 
__STILL A WORK IN PROGRESS__

Here we have a few tiers of 'research field' so need to discuss how to divide these up. Broadly we categorized these into general fields of study but the biology field was so big we wanted to divide this up further. There are edits I still have to make:
* divide up "ecosystem/habitat" into "modelling" and "habitat"
* separate out "oil" studies from "chemical" and make a separate group for this

Whatever design we chose we'll want to be consistent between Q3 & Q4. Therefore see also below for different layouts. Note: I realize that the text nProjects on the % bars is redundant, I just left them to see if that's enough information to get an idea of differences in nProjects, rather than another graph.


```{r research field success plots,fig.height=11, echo=FALSE}

catYN=as.data.frame(table(rslt2$dataType,rslt2$succ))
colnames(catYN)=c('category','succ','nDatasets')

broadSpl=strsplit(as.character(catYN$category),'-')
catYN$broad=sapply(broadSpl,function(x) x[1])
bioSub=sapply(broadSpl,function(x) x[2])

bioYN=catYN %>%
  filter(broad=='biological') %>%
  mutate(subCat=na.omit(bioSub)) %>%
  group_by(category) %>%
  mutate(grpTots=sum(nDatasets)) %>%
  mutate(prop=nDatasets/grpTots)

bioYN$subCat=factor(bioYN$subCat,levels=c('plankton','benthicInverts','fish','birds','mammals'))

##### general fields (biology grouped)

sums=bioYN %>%
  group_by(succ) %>%
  summarise(nDatasets=sum(nDatasets)) %>%
  mutate(category='biological') %>%
  select(category,succ,nDatasets)

broadDf=catYN %>%
  filter(!broad=='biological') %>%
  group_by(broad) %>%
  mutate(grpTots=sum(nDatasets)) %>%
  mutate(prop=nDatasets/grpTots)
  
broadDf$category<-factor(broadDf$category,levels=c('physical','chemical','biological','ecosystem/habitat','social'))
broadDf[9:10,]<-sums
broadDf[9:10,'prop'] <- c(broadDf$nDatasets[9]/sum(sums$nDatasets),broadDf$nDatasets[10]/sum(sums$nDatasets))
broadDf[9:10,'grpTots'] <- sum(sums$nDatasets)

broadNds=ggplot(broadDf[broadDf$succ==0,],aes(x=category,y=grpTots))+
  geom_bar(stat = "identity",fill="grey")+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())+
  ggtitle('General fields')+
  ylab('Number of datasets\n')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))
  
broadPerc=ggplot(broadDf[broadDf$succ==0,],aes(x=category,y=(prop*100)))+
  geom_bar(stat = "identity",fill="black")+
  scale_x_discrete(labels=c("physical","chemical","biological","eco/hab","social"))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(angle=90))+
  xlab('Field')+
  ylab('% successful')+
  ylim(0,75)+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))+
  annotate("text", x = 1, y=broadDf$prop[[3]]*100+3, label = as.character(broadDf[broadDf$category=="physical" & broadDf$succ==0,"grpTots"]))+
  annotate("text", x = 2, y=broadDf$prop[[1]]*100+3, label = as.character(broadDf[broadDf$category=="chemical" & broadDf$succ==0,"grpTots"]))+
  annotate("text", x = 3, y=broadDf$prop[[9]]*100+3, label = as.character(broadDf[broadDf$category=="biological" & broadDf$succ==0,"grpTots"]))+
  annotate("text", x = 4, y=broadDf$prop[[2]]*100+3, label = as.character(broadDf[broadDf$category=="ecosystem/habitat" & broadDf$succ==0,"grpTots"]))+
  annotate("text", x = 5, y=broadDf$prop[[4]]*100+3, label = as.character(broadDf[broadDf$category=="social" & broadDf$succ==0,"grpTots"]))

#biology fields

bioPerc=ggplot(bioYN[bioYN$succ==0,],aes(x=subCat,y=(prop*100)))+
  geom_bar(stat = "identity",fill="black")+
  scale_x_discrete(labels=c("plankton","inverts","fish","birds","mammals"))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90),
        axis.title.y = element_blank())+
  ylim(0,75)+
  xlab('Bio Field')+
  #ylab('% successful')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))+
  annotate("text", x = 1, y=bioYN$prop[[5]]*100+3, label = as.character(bioYN[bioYN$category=="biological-plankton" & bioYN$succ==0,"grpTots"]))+
  annotate("text", x = 2, y=bioYN$prop[[1]]*100+3, label = as.character(bioYN[bioYN$category=="biological-benthicInverts" & bioYN$succ==0,"grpTots"]))+
  annotate("text", x = 3, y=bioYN$prop[[3]]*100+3, label = as.character(bioYN[bioYN$category=="biological-fish" & bioYN$succ==0,"grpTots"]))+
  annotate("text", x = 4, y=bioYN$prop[[2]]*100+3, label = as.character(bioYN[bioYN$category=="biological-birds" & bioYN$succ==0,"grpTots"]))+
  annotate("text", x = 5, y=bioYN$prop[[4]]*100+3, label = as.character(bioYN[bioYN$category=="biological-mammals" & bioYN$succ==0,"grpTots"]))

bioNds=ggplot(bioYN[bioYN$succ==0,],aes(x=subCat,y=grpTots))+
  geom_bar(stat = "identity",fill="grey")+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_blank(),
        axis.title = element_blank())+
  #ylim=c(0,300)+
  ggtitle('Biology sub-fields')+
  ylab('Number of datasets\n')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))

grid.arrange(broadNds,bioNds,broadPerc,bioPerc, ncol = 2,heights=c(1,1.5))

```

***

# 4. Awardee agency type
> Are there certain **sectors** that are more likely to make data available than others?
(based on PI's affiliation)

We want to display these results similar to above (#3). Here is another way we can display each of these (#3 & #4)

***

```{r, subSector stacked, fig.height=10,echo=FALSE}
secSubYN=as.data.frame(table(rslt2$agSubGrp,rslt2$succ))
colnames(secSubYN)=c('subSector','succ','nDatasets')

secSubYN2=secSubYN %>%
  group_by(subSector) %>%
  mutate(prop=nDatasets/sum(nDatasets))
secSubYN2$subSector=factor(secSubYN2$subSector,levels=c("gov_fed","gov_state","academia","nonProf","private","tribe"),ordered = T)

subSecNds=ggplot(secSubYN2,aes(x=subSector,y=nDatasets))+
  geom_bar(stat = "identity",fill="grey")+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())+
  ylab('Number of Projects\n')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))

subSecPerc=ggplot(secSubYN2[secSubYN2$succ==0,],aes(x=subSector,y=as.numeric(prop*100)))+
  geom_bar(stat = "identity",fill="black")+
  scale_x_discrete(breaks=levels(secSubYN2$subSector),
                   labels=c("govFed","govState","academia","nonProfit","forProfit","tribes"))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(angle=90))+
  xlab('Sector')+
  ylab('% successful\n')+
  ylim(0,75)+
  #ggtitle('Percent success by research sector type')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))

grid.arrange(subSecNds, subSecPerc, ncol = 1, heights=c(1,1.75))
```

***

# 5. Temporal trends?
> Is the availability of data correlated to how old the data are?

We decided we are intersted in the percent success, so again, successes we grouped and percent was calculated based on each year total. We also wanted to display the number of datasets since it varies a lot and especially in the later years there is a significant increase in success, likely due to a decrease in projects, among other things (such as relationships to data collectors, etc.)

Here I have these data in two ways:

* Stacked plots of N projects and % success similar to above
* Grouped bars with N project and % success for each year together. (I am aware of the  squished right label, thanks.)

The markdown file "temporalPlots.Rmd" shows all of our other test plots.

```{r temporal - stacked plots,fig.height=10, echo=F, message=F, warning=F}

rslt2$succ<-ifelse(rslt2$Status %in% c('Unrecoverable','Emailed','Replied'),1,0)

endYr=rslt2 %>%
  filter(!end<1989) %>%
  filter(!end>2010) %>%
  select(succ,end)

endYrs=as.data.frame(table(endYr$end,endYr$succ))
colnames(endYrs)=c('year','succ','freq')
endYrs<- mutate(endYrs,since=(2012-as.numeric(paste(endYrs$year))))

yrsPropEnd<-endYrs %>%
  group_by(as.character(year)) %>%
  mutate(yrSum=sum(freq)) %>%
  mutate(prop=freq/yrSum)

yrsNds=ggplot(yrsPropEnd[yrsPropEnd$succ==0,],aes(x=since,y=yrSum)) +
  geom_bar( stat="identity",fill="red")+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.title.y=element_text(color="black"),
        axis.title.x=element_blank())+
  xlim(max(endYrs$since),min(endYrs$since))+
  #ylim(0,100)+ 
  #xlab('Years since funding award')+
  ylab('Number\nof Projects')+
  theme(legend.position="none",
        axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"),
        axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))


yrsPerc=ggplot(yrsPropEnd[yrsPropEnd$succ==0,],aes(x=since,y=as.numeric(prop*100)))+
  geom_bar(stat = "identity",fill="blue")+
  xlim(max(endYrs$since),min(endYrs$since))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  xlab('Sector')+
  ylab('% successful\n')+
  ylim(0,75)+
  #ggtitle('Percent success by research sector type')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))

grid.arrange(yrsNds, yrsPerc, ncol = 1, heights=c(1,1.5))
```

***

```{r temporal-groupedBars, echo=FALSE, message=F, warning=FALSE}
grpd<-yrsPropEnd
grpd$prop[23:44]<-0
grpd$yrSum[23:44]<-0

propBar=ggplot(grpd,aes(x=since,y=(prop*100),fill = succ)) +
  geom_bar(position = "dodge", stat="identity")+
  scale_fill_manual(values = c("red", "red"))+
  #scale_x_continuous(breaks = 1:10)+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black",fill=NA),
        panel.background = element_blank(),
        axis.title.y=element_text(color="red"))+
  xlim(max(endYrs$since),min(endYrs$since))+
  ylim(0,100)+ 
  #xlab('Years since funding award')+
  ylab('% successful')+
  #ggtitle('Percent over time')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"),
        legend.position="none")


nBar <- ggplot(grpd,aes(x=since,y=yrSum,fill = rev(succ)))+
  geom_bar(position = "dodge", stat="identity")+
  scale_fill_manual(values = c("blue", "blue"))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.title.y=element_text(color="blue"))+
  xlim(max(endYrs$since),min(endYrs$since))+
  xlab('Years since project ended')+
  ylab('Number of Projectss')+
  #ggtitle('Number of EVOS datasets collected\nbased on the number of years since a project ended')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"),
        legend.position="none")

# extract gtable
pb <- ggplot_gtable(ggplot_build(nBar))
nb <- ggplot_gtable(ggplot_build(propBar))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(pb$layout, name == "panel", se = t:r))
g <- gtable_add_grob(pb, nb$grobs[[which(nb$layout$name == "panel")]], pp$t, 
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(nb$layout$name == "axis-l")
ga <- nb$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, nb$widths[nb$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
g <- gtable_add_grob(g, nb$grob[[7]], pp$t, length(g$widths), pp$b)
# draw it
grid.draw(g)
```

***

# s1. Reasons for not sharing

> Why don't people share data?

Here I used all of the data that were not collected and sorted them into categories based on the redmine notes we took:

* All datasets labeled "emailed" were grouped with a other datasets that were labeled "unrecoverable" because no contact information could be found.
* All datasets labeled "replied" we put into their own category called "communication lost".
* The "data lost" category includes all datasets in which someone confirmed that the data no longer existed either due to damage, non-persistent formats (not including printed/non-digital), etc.
* The other are self-explanatory, but represent confirmed responses as to one of these reasons.
* __TO DOs:__ I plan to separate out the datasets that were not recovered but "should be on the CD" and sort these into their own category too.

```{r Unrecoverable reasons, echo=F}
reas=rslt2 %>%
  filter(Status=='Unrecoverable') %>%
  filter(!reason=="no data generated") %>%
  filter(!reason=="data uvailable") %>%
  select(Status,reason)
reasTab=as.data.frame(table(reas$reason))
colnames(reasTab)=c('reason','nDatasets')

## add in status = 'emailed' to 'no contact info' & status = "replied" to unwilling to share? ...discuss with group

reasTab[reasTab$reason=='no contact info',"nDatasets"] <- (reasTab[reasTab$reason=='no contact info',"nDatasets"] + length(rslt2[rslt2$Status=='Emailed','Status'])) 

levels(reasTab$reason)=c(levels(reasTab$reason),'communication lost')

reasTab[6,]<-c('communication lost', length(rslt2[rslt2$Status=='Replied','Status'])+1)# +1 for one of the 'data unavailable' datasets, add the other to "data lost"
reasTab[1,2]<-as.numeric(as.character(reasTab[reasTab$reason=="data lost","nDatasets"]))+1

reasTab<-arrange(reasTab,desc(as.numeric(nDatasets)))
reasTab$reason<-factor(reasTab$reason,levels = reasTab$reason,ordered = T)

whyNot<-ggplot(reasTab,aes(x=reason,y=as.numeric(nDatasets)))+
  geom_bar(stat = "identity")+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #xlab('\nReason data were not recovered')+
  ylab('Number of Projects\n')+
  ggtitle('Why are data not recovered?')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) ## *** add each n as text above bar
whyNot
```



_Note: We have reinvigorated these efforts for one last year and I plan to add the added progress from the latest recovery efforts to the discussion section._