---
title: "EVOSTC data collection paper - Data Visualizations"
author: "Jessica Couture"
date: "5/8/2016"
output: html_document
---

#Background

We are writing up a publication to report results of a two year data archiving effort by a small group of researchers and students at the National Center for Ecological Analysis and Synthesis at UC Santa Barbara. The [Exxon Valdez Oil Spill Trustee Council](http://www.evostc.state.ak.us) (EVOSTC) was formed following the Exon Valdez oil spill in Alaska in 1989. Since then, the EVOSTC has funded hundreds of projects and in 2012 we began a project to recover and archive the data collected in these EVOSTC funded projects.

For this paper we ask 4 main questions about the data collected from the Exxon Valdez Oil Spill Trustee Council funded projects:

1. Twenty-five years after the EVOS, for how many projects funded by EVOSTC can we collect data?
2. Are there certain **research fields** that are more likely to make data available than others?
3. Are there certain **sectors** that are more likely to make data available than others?
4. Is the availability of data correlated to how old the data are? (temporal relationships?)

Additionally we are exploring the following supplemental questions:

s1. Why did people refuse to share their data?
s2. how do our results compare to other similar studies


#Data setup
*Pull in data and add agency affiliation and minor formatting
*Load required libraries:
  - library(dplyr)
  - library(readr)
  - library(ggpot2)
  - library(reshape)
  - library(gridExtra)
*Set colors

```{r data prep,echo=FALSE,message=FALSE}

library(knitr)
library(dplyr)
library(readr)
library(ggplot2)
library(reshape2)
library(grid)
library(gridExtra)

rslt=read.csv('data/archResRevised.csv',header=T,stringsAsFactors=F)
rslt[rslt$Status=='published','Status']<-'Published'

rslt$succ=ifelse(rslt$Status %in% c('Published','SentData','Revised'),'aff','neg')
rslt$statSucc=ifelse(rslt$Status %in% c('Published','SentData','Revised'),1,2) # 1 = success, 2 = not successful

agDes=read.csv('data/ecoInfoAgencyDesig.csv',header=T,stringsAsFactors=T,col.names=c('agency','agGrp','agSubGrp'))
agDes$agGrp=gsub('nonProf','private',agDes$agGrp)

rslt2=merge(rslt,agDes,all.x=T)
```
Data table="rslt2"

```{r}
statusCols=c('Unrecoverable'='orangered',
             'Emailed'='orange',
             'Replied'='gold',
             'SentData'='darkolivegreen2',
             'Revised'='darkolivegreen3',
             'Published'='forestgreen')

succCols=c('aff'='grey17',
           'neg'='grey89')

```

# 1. Project Status Reporting
<h4>Twenty-five years after the EVOS, for how many projects funded by EVOSTC can we collect data?</h4>
 
### Plot status of datasets at the end of the initial archiving effort:
```{r status plot,echo=FALSE}

overall=table(rslt2$Status)
overallLong=melt(overall)
colnames(overallLong)=c('Status','nDatasets')
overall2=overallLong %>%
  mutate(prop=nDatasets/sum(nDatasets))

possible=overallLong %>%
  filter(!Status=='Unrecoverable') %>%
  mutate(prop=nDatasets/sum(nDatasets))

statusOrd=c('Unrecoverable','Emailed','Replied','SentData','Revised','Published')
#rslt2$Status=as.factor(rslt2$Status,levels=statusOrd,ordered=T)

statPlot=ggplot()+
  geom_bar(data=rslt2,
                 aes(x=factor(Status,levels=statusOrd,ordered=T),fill=Status))+
  scale_fill_manual(labels=statusOrd,values=statusCols,breaks=statusOrd)+
  theme(legend.title=element_blank())+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  #theme(axis.text.x = element_text(angle=90))+
  xlab('Status')+
  ylab('Number of datasets\n')+
  ggtitle('Dataset status distribution')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"),
        legend.text = element_text(size = 14, face = "bold"))

statPerc=ggplot(overall2,aes(x=factor(Status,levels=statusOrd,ordered=T),y=prop,fill=Status))+
  geom_bar(stat = "identity")+
  scale_fill_manual(labels=statusOrd,values=statusCols,breaks=statusOrd)+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Status')+
  ylab('Percent\n')+
  ggtitle('Percent of datasets in each stage')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))

grid.arrange(statPlot,statPerc, ncol = 1)

 # GOOD!
```


---

# 2.Data type category
### Are there certain **research fields** that are more likely to make data available than others?

### PLOT: Successes by research field
```{r research field success plots, echo=FALSE}

yrsCols=c("neg"='grey',
          "aff"='black')

catYN=as.data.frame(table(rslt2$dataType,rslt2$succ))
colnames(catYN)=c('category','succ','nDatasets')

broadSpl=strsplit(as.character(catYN$category),'-')
catYN$broad=sapply(broadSpl,function(x) x[1])
bioSub=sapply(broadSpl,function(x) x[2])

bioYN=catYN %>%
  filter(broad=='biological') %>%
  mutate(subCat=na.omit(bioSub)) %>%
  group_by(category) %>%
  mutate(prop=nDatasets/sum(nDatasets))
bioYN$subCat=factor(bioYN$subCat,levels=c('plankton','benthicInverts','fish','birds','mammals'))

##### general fields (biology grouped)

sums=bioYN %>%
  group_by(succ) %>%
  summarise(nDatasets=sum(nDatasets)) %>%
  mutate(category='biological') %>%
  select(category,succ,nDatasets)

broadDf=catYN %>%
  filter(!broad=='biological') %>%
  group_by(category) %>%
  mutate(prop=nDatasets/sum(nDatasets))
  
broadDf$category<-factor(broadDf$category,levels=c('physical','chemical','biological','ecosystem/habitat','social'))
broadDf[9:10,]<-sums

broadSucc=ggplot(broadDf,aes(x=category,y=nDatasets,fill=succ,order=rev(succ)))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Field')+
  ylab('Number of datasets\n')+
  ggtitle('Successes by project type')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))

broadPerc=ggplot(broadDf[broadDf$succ=='aff',],aes(x=category,y=prop,order=rev(succ)))+
  geom_bar(stat = "identity")+
  #scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Field')+
  ylab('Number of datasets\n')+
  ggtitle('Percent success by biology field')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))

grid.arrange(broadSucc,broadPerc, ncol = 1)

```
### PLOT: Successes within the biology field
```{r BIOLOGY research field success plots,echo=FALSE}

bioSucc=ggplot(bioYN,aes(x=subCat,y=nDatasets,fill=succ,order=rev(succ)))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Field')+
  ylab('Number of datasets\n')+
  ggtitle('Successes of biology fields')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))

bioPerc=ggplot(bioYN[bioYN$succ=='aff',],aes(x=subCat,y=prop,order=rev(succ)))+
  geom_bar(stat = "identity")+
  #scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Field')+
  ylab('Number of datasets\n')+
  ggtitle('Percent success by biology field')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))

grid.arrange(bioSucc, bioPerc, ncol = 1)
```

---

# 3. Awardee agency type
### Are there certain **sectors** that are more likely to make data available than others?
(based on PI's affiliation)


### PLOT: Success by sector

``` {r sector success plot,echo=FALSE}

secYN=as.data.frame(table(rslt2$agGrp,rslt2$succ))
colnames(secYN)=c('sector','succ','nDatasets')

secYN2=secYN %>%
  group_by(sector) %>%
  mutate(prop=nDatasets/sum(nDatasets))
secYN$sector=factor(secYN$sector,levels=c('academia','government','private','tribe'))


secSucc=ggplot(secYN2,aes(x=sector,y=nDatasets,fill=succ,order=rev(succ)))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Sector')+
  ylab('Number of datasets\n')+
  ggtitle('Successes based on reaserch sector')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))

secPerc=ggplot(secYN2[secYN2$succ=='aff',],aes(x=sector,y=prop,order=rev(succ)))+
  geom_bar(stat = "identity")+
  #scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Sector')+
  ylab('Percent\n')+
  ggtitle('Percent success by biology field')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))

grid.arrange(secSucc, secPerc, ncol = 1)
```

### PLOT: successes by more specific sectors

```{r}
secSubYN=as.data.frame(table(rslt2$agSubGrp,rslt2$succ))
colnames(secSubYN)=c('subSector','succ','nDatasets')

secSubYN2=secSubYN %>%
  group_by(subSector) %>%
  mutate(prop=nDatasets/sum(nDatasets))
secSubYN$sector=factor(secSubYN$sector,levels=c('academia','government','private','tribe'))


subSecSucc=ggplot(secSubYN2,aes(x=subSector,y=nDatasets,fill=succ,order=rev(succ)))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Sector')+
  ylab('Number of datasets\n')+
  ggtitle('Successes based on reaserch sector type')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))

subSecPerc=ggplot(secSubYN2[secSubYN2$succ=='aff',],aes(x=subSector,y=prop,order=rev(succ)))+
  geom_bar(stat = "identity")+
  #scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Sector')+
  ylab('Percent\n')+
  ggtitle('Percent success by research sector type')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))

grid.arrange(subSecSucc, subSecPerc, ncol = 1)
```
---

# 4. Temporal relationships
### Is the availability of data correlated to how old the data are?

### Plot of data reporting based on the year a project was funded to represent length of time since data were produced
```{r temporal-endYr}

rslt2$succ<-ifelse(rslt2$Status %in% c('Unrecoverable','Emailed','Replied'),1,0)

endYr=rslt2 %>%
  filter(!end<1989) %>%
  filter(!end>2010) %>%
  select(succ,end)

endYrs=as.data.frame(table(endYr$end,endYr$succ))
colnames(endYrs)=c('year','succ','freq')

yrsCols=c("1"='orangered',
           "0"='forestgreen')

ggplot(endYrs,aes(x=year,y=freq,fill=succ,order=rev(succ)))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values=yrsCols,name='Success?',breaks=c('1','0'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  xlab('Year')+
  ylab('Number of datasets\n')+
  ggtitle('Temporal distrtibution of EVOS datasets collected\nbased on the LAST year projects were funded')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))
```

### plot of data reporting based on the year the data were funded
```{r temporal}
yrsList=list()
placer=1
for(i in 1:nrow(rslt2)) {
  yrsList[[i]]=as.numeric(rslt2$start[i]):as.numeric(rslt2$end[i])
  placer=placer+1
}

yrsDf=ldply(yrsList,rbind)
yrsDf$status=rslt2$Status
yrsDf$category=rslt2$category
colnames(yrsDf)=c(paste('yrs',colnames(yrsDf)[1:89],sep='.'),'status','category')

yrsLng=reshape(yrsDf,varying=c(1:89),direction='long')
yrs3=yrsLng %>%
  filter(!is.na(yrs)) %>% 
  filter(!yrs<1989) %>%
  filter(!yrs>2010) %>%
  select(status,category,yrs)

totYrs=as.data.frame(table(yrs3$yrs,yrs3$succ))
colnames(totYrs)=c('year','succ','freq')

yrsCols=c("1"='orangered',
           "0"='forestgreen')

ggplot(totYrs,aes(x=year,y=freq,fill=succ,order=rev(succ)))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values=yrsCols,name='Success?',breaks=c('1','0'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  xlab('Year')+
  ylab('Number of datasets\n')+
  ggtitle('Temporal distrtibution of EVOS datasets collected\nbased on year data were collected')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold")) ### GOOD!
```

#Why don't people share data?

# s2 - Comparison with other studies:

This is one of four studies I found that look at the ability to recover data that is supposed to be publicly available

```{r comparison data, echo=FALSE}

comp=data.frame(study=c('SavageVickers2009','WichertsEtAl2006','Wolins1962','evostcProject'),
                n=c(10,249,37,406),
                successRate=c(0.10,0.26,0.24,0.32))
comp

stComparison<-ggplot(comp,aes(x=study,y=successRate))+
  geom_bar(stat = "identity")+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  xlab('\nSector of PIs home institution')+
  ylim(0,0.5)+
  ylab('Proportion\n')+
  ggtitle('Percent successful data recoveries for four studies')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold")) ## *** add each n as text above bar
stComparison
```
