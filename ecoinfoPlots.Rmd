---
title: "EVOSTC data collection paper - Data Visualizations"
author: "Jessica Couture"
date: "5/8/2016"
output: html_document
---

#Background

We are writing up a publication to report results of a two year data archiving effort by a small group of researchers and students at the National Center for Ecological Analysis and Synthesis at UC Santa Barbara. The [Exxon Valdez Oil Spill Trustee Council](http://www.evostc.state.ak.us) (EVOSTC) was formed following the Exon Valdez oil spill in Alaska in 1989. Since then, the EVOSTC has funded hundreds of projects and in 2012 we began a project to recover and archive the data collected in these EVOSTC funded projects.

For this paper we ask 4 main questions about the data collected from the Exxon Valdez Oil Spill Trustee Council funded projects:

1. Twenty-five years after the EVOS, for how many projects funded by EVOSTC can we collect data?
2. Are there certain **research fields** that are more likely to make data available than others?
3. Are there certain **sectors** that are more likely to make data available than others?
4. Is the availability of data correlated to how old the data are? (temporal relationships?)

Additionally we are exploring the following supplemental questions:

1. Why did people refuse to share their data?
2. how do our results compare to other similar studies
    + person hours?
3. Total elapsed time from inital contact to data publication
    + not sure we'll have the data for this

```{r data prep,echo=FALSE,message=FALSE}

library(knitr)
library(dplyr)
library(readr)
library(ggplot2)
library(reshape2)
library(grid)
library(gridExtra)

rslt=read.csv('data/archResRevised.csv',header=T,stringsAsFactors=F)
rslt[rslt$Status=='published','Status']<-'Published'

rslt$succ=ifelse(rslt$Status %in% c('Published','SentData','Revised'),'aff','neg')
rslt$statSucc=ifelse(rslt$Status %in% c('Published','SentData','Revised'),1,2) # 1 = success, 2 = not successful

agDes=read.csv('data/ecoInfoAgencyDesig.csv',header=T,stringsAsFactors=T,col.names=c('agency','agGrp','agSubGrp'))
agDes$agGrp=gsub('nonProf','private',agDes$agGrp)

rslt2=merge(rslt,agDes,all.x=T)
```

```{r, echo=F}
statusCols=c('Unrecoverable'='orangered',
             'Emailed'='orange',
             'Replied'='gold',
             'SentData'='darkolivegreen2',
             'Revised'='darkolivegreen3',
             'Published'='forestgreen')

succCols=c('aff'='grey17',
           'neg'='grey89')

```

# 1. Project Status Reporting
> Twenty-five years after the EVOS, for how many projects funded by EVOSTC can we collect data?</h4>

For this first question, we should use the original plot generated from redmine that simply displays the number of datasets in each staus at the end to the 2 year data collection effort

```{r status plot, fig.width=10,echo=FALSE}

overall=table(rslt2$Status)
overallLong=melt(overall)
colnames(overallLong)=c('Status','nDatasets')
overall2=overallLong %>%
  mutate(prop=nDatasets/sum(nDatasets))

possible=overallLong %>%
  filter(!Status=='Unrecoverable') %>%
  mutate(prop=nDatasets/sum(nDatasets))

statusOrd=c('Unrecoverable','Emailed','Replied','SentData','Revised','Published')
#rslt2$Status=as.factor(rslt2$Status,levels=statusOrd,ordered=T)

statPlot=ggplot()+
  geom_bar(data=rslt2,
                 aes(x=factor(Status,levels=statusOrd,ordered=T),fill=Status))+
  scale_fill_manual(labels=statusOrd,values=statusCols,breaks=statusOrd)+
  theme(legend.title=element_blank())+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  #theme(axis.text.x = element_text(angle=90))+
  xlab('Status')+
  ylab('Number of datasets\n')+
  ggtitle('Dataset status distribution')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"),
        legend.text = element_text(size = 14, face = "bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))

statPlot

```

***

# 2.Research field
> Are there certain **research fields** that are more likely to make data available than others?

Here we have a few tiers of 'research field' so need to discuss how to divide these up. We are also still playing with whether to post number of datasets or percent successes for each field of study. 

See also the categoryPlots.rmd for more details on this using question 3 as an example. Which ever we chose (n or %) we'll be consistent between Q2 & Q3. Although, both have their own 2 levels of breaking up the data which doesn't need to be consistent between the two.

### PLOT: Successes by research field
```{r research field success plots, echo=FALSE}

yrsCols=c("neg"='grey',
          "aff"='black')

catYN=as.data.frame(table(rslt2$dataType,rslt2$succ))
colnames(catYN)=c('category','succ','nDatasets')

broadSpl=strsplit(as.character(catYN$category),'-')
catYN$broad=sapply(broadSpl,function(x) x[1])
bioSub=sapply(broadSpl,function(x) x[2])

bioYN=catYN %>%
  filter(broad=='biological') %>%
  mutate(subCat=na.omit(bioSub)) %>%
  group_by(category) %>%
  mutate(prop=nDatasets/sum(nDatasets))
bioYN$subCat=factor(bioYN$subCat,levels=c('plankton','benthicInverts','fish','birds','mammals'))

##### general fields (biology grouped)

sums=bioYN %>%
  group_by(succ) %>%
  summarise(nDatasets=sum(nDatasets)) %>%
  mutate(category='biological') %>%
  select(category,succ,nDatasets)

broadDf=catYN %>%
  filter(!broad=='biological') %>%
  group_by(category) %>%
  mutate(prop=nDatasets/sum(nDatasets))
  
broadDf$category<-factor(broadDf$category,levels=c('physical','chemical','biological','ecosystem/habitat','social'))
broadDf[9:10,]<-sums

broadSucc=ggplot(broadDf,aes(x=category,y=nDatasets,fill=succ,order=rev(succ)))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Field')+
  ylab('Number of datasets\n')+
  #ggtitle('Successes by project type')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))
broadSucc

broadPerc=ggplot(broadDf[broadDf$succ=='aff',],aes(x=category,y=prop,order=rev(succ)))+
  geom_bar(stat = "identity")+
  #scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Field')+
  ylab('Percent successful')+
  #ggtitle('Percent success by biology field')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))
broadPerc
#grid.arrange(broadSucc,broadPerc, ncol = 1)

```

***

### PLOT: Successes within the biology field
These can be included in the 'broader fields' plots above as a replacement for 'biology' but might be too specific to be relevant.

```{r BIOLOGY research field success plots,echo=FALSE}

bioSucc=ggplot(bioYN,aes(x=subCat,y=nDatasets,fill=succ,order=rev(succ)))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Field')+
  ylab('Number of datasets\n')+
  ggtitle('Successes of biology fields')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))
bioSucc

bioPerc=ggplot(bioYN[bioYN$succ=='aff',],aes(x=subCat,y=prop,order=rev(succ)))+
  geom_bar(stat = "identity")+
  #scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Field')+
  ylab('Percent successful')+
  ggtitle('Percent success by biology field')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))
bioPerc
#grid.arrange(bioSucc, bioPerc, ncol = 1)
```

***

# 3. Awardee agency type
> Are there certain **sectors** that are more likely to make data available than others?
(based on PI's affiliation)

Similar to above. I think, here, we were leaning towards the more specific groupings represented in the lower set of plots.

``` {r sector success plot,echo=FALSE}

secYN=as.data.frame(table(rslt2$agGrp,rslt2$succ))
colnames(secYN)=c('sector','succ','nDatasets')

secYN2=secYN %>%
  group_by(sector) %>%
  mutate(prop=nDatasets/sum(nDatasets))
secYN$sector=factor(secYN$sector,levels=c('academia','government','private','tribe'))


secSucc=ggplot(secYN2,aes(x=sector,y=nDatasets,fill=succ,order=rev(succ)))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Sector')+
  ylab('Number of datasets\n')+
  ggtitle('Successes based on reaserch sector')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))
secSucc
```

***

```{r, echo=FALSE}
secPerc=ggplot(secYN2[secYN2$succ=='aff',],aes(x=sector,y=prop,order=rev(succ)))+
  geom_bar(stat = "identity")+
  #scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Sector')+
  ylab('Percent successful\n')+
  ggtitle('Percent success by biology field')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))
secPerc
#grid.arrange(secSucc, secPerc, ncol = 1)
```

***

```{r, echo=FALSE}
secSubYN=as.data.frame(table(rslt2$agSubGrp,rslt2$succ))
colnames(secSubYN)=c('subSector','succ','nDatasets')

secSubYN2=secSubYN %>%
  group_by(subSector) %>%
  mutate(prop=nDatasets/sum(nDatasets))
secSubYN$sector=factor(secSubYN$subSector,levels=c('academia','government','private','tribe'))


subSecSucc=ggplot(secSubYN2,aes(x=subSector,y=nDatasets,fill=succ,order=rev(succ)))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values=yrsCols,name='Success?',breaks=c('neg','aff'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  scale_x_discrete(breaks=unique(secSubYN2$subSector),
                   labels=c("academia","gov_fed","gov_state","nonProfit","consulting","tribes"))+
  xlab('Sector')+
  ylab('Number of datasets\n')+
  ggtitle('Successes based on reaserch sector type')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))
subSecSucc

subSecPerc=ggplot(secSubYN2[secSubYN2$succ=='aff',],aes(x=subSector,y=(prop*100),order=rev(succ)))+
  geom_bar(stat = "identity")+
  scale_x_discrete(breaks=unique(secSubYN2$subSector),
                   labels=c("academia","gov_fed","gov_state","nonProfit","consulting","tribes"))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #ylim=c(0,300)+
  xlab('Sector')+
  ylab('Percent successful\n')+
  ggtitle('Percent success by research sector type')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))
subSecPerc
#grid.arrange(subSecSucc, subSecPerc, ncol = 1)
```
---

# 4. Temporal relationships
> Is the availability of data correlated to how old the data are?

Similar to Q2 & Q3, we have two dimensions we still need feedback on:

1. Should we represent percents, raw values or both? How?
2. Show we count each project once or each year of funding?
   + Since the rest of the analyses treat datasets semi-equal to projects, particularly for those projects we don't know much about, it makes sense to represent these as one data point for each project funded rather than for each year a project was funded.
   + Including each year a project was funded in the plots gives more weight to the longer datasets, setting appart long timeseries from one year studies. Also, since the EVOSTC required separate continuation applications for subsequent years of funding they can be considered different projects. This makes more sense to me, but does stray from how we had represented "projects" previously. Perhaps differing terminology could help clarify/separate these ideas.
   
Again, see the specific markdown file for more plots and details

```{r temporal-endYr, echo=FALSE, message=F, warning=FALSE}

rslt2$succ<-ifelse(rslt2$Status %in% c('Unrecoverable','Emailed','Replied'),1,0)

endYr=rslt2 %>%
  filter(!end<1989) %>%
  filter(!end>2010) %>%
  select(succ,end)

endYrs=as.data.frame(table(endYr$end,endYr$succ))
colnames(endYrs)=c('year','succ','freq')

yrsCols=c("1"='orangered',
           "0"='forestgreen')

ggplot(endYrs,aes(x=year,y=freq,fill=succ,order=rev(succ)))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values=yrsCols,name='Success?',breaks=c('1','0'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  xlab('Year')+
  ylab('Number of datasets\n')+
  ggtitle('Temporal distrtibution of EVOS datasets collected\nbased on the LAST year projects were funded')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))
```

***

```{r temporal, echo=F, message=F, warning=F}
library(plyr)
yrsList=list()
placer=1
for(i in 1:nrow(rslt2)) {
  yrsList[[i]]=as.numeric(rslt2$start[i]):as.numeric(rslt2$end[i])
  placer=placer+1
}

yrsDf=ldply(yrsList,rbind)
yrsDf$status=rslt2$Status
yrsDf$category=rslt2$category
colnames(yrsDf)=c(paste('yrs',colnames(yrsDf)[1:89],sep='.'),'status','category')

yrsLng=reshape(yrsDf,varying=c(1:89),direction='long')
yrs3=yrsLng %>%
  filter(!is.na(yrs)) %>% 
  filter(!yrs<1989) %>%
  filter(!yrs>2010) %>%
  mutate(succ=ifelse(status %in% c('Published','SentData','Revised'),'aff','neg')) %>%
  select(succ,category,yrs)

totYrs=as.data.frame(table(yrs3$yrs,yrs3$succ))
colnames(totYrs)=c('year','succ','freq')

yrsCols=c("neg"='orangered',
          "aff"='forestgreen')

ggplot(totYrs,aes(x=year,y=freq,fill=succ,order=rev(succ)))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values=yrsCols,name='Success?',breaks=c('aff','neg'),labels=c('no','yes'))+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  xlab('Year')+
  ylab('Number of datasets\n')+
  ggtitle('Temporal distrtibution of EVOS datasets collected\nbased on year data were collected')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) ### GOOD!
```

***

# s1. Reasons for not sharing

> Why don't people share data?

Here I used all of the data that were not collected and sorted them into categories based on the redmine notes we took:

* All datasets labeled "emailed" were grouped with a other datasets that were labeled "unrecoverable" because no contact information could be found.
* All datasets labeled "replied" we put into their own category called "communication lost".
* The "data lost" category includes all datasets in which someone confirmed that the data no longer existed either due to damage, non-persistent formats (not including printed/non-digital), etc.
* The other are self-explanatory, but represent confirmed responses as to one of these reasons.

```{r Unrecoverable reasons, echo=F}
reas=rslt2 %>%
  filter(Status=='Unrecoverable') %>%
  filter(!reason=="no data generated") %>%
  filter(!reason=="data uvailable") %>%
  select(Status,reason)
reasTab=as.data.frame(table(reas$reason))
colnames(reasTab)=c('reason','nDatasets')

## add in status = 'emailed' to 'no contact info' & status = "replied" to unwilling to share? ...discuss with group

reasTab[reasTab$reason=='no contact info',"nDatasets"] <- (reasTab[reasTab$reason=='no contact info',"nDatasets"] + length(rslt2[rslt2$Status=='Emailed','Status'])) 

levels(reasTab$reason)=c(levels(reasTab$reason),'communication lost')

reasTab[6,]<-c('communication lost', length(rslt2[rslt2$Status=='Replied','Status'])+1)# +1 for one of the 'data unavailable' datasets, add the other to "data lost"
reasTab[1,2]<-as.numeric(as.character(reasTab[reasTab$reason=="data lost","nDatasets"]))+1

reasTab<-arrange(reasTab,desc(as.numeric(nDatasets)))
reasTab$reason<-factor(reasTab$reason,levels = reasTab$reason,ordered = T)

whyNot<-ggplot(reasTab,aes(x=reason,y=as.numeric(nDatasets)))+
  geom_bar(stat = "identity")+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  #xlab('\nReason data were not recovered')+
  ylab('Number of datasets\n')+
  ggtitle('Why are data not recovered?')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black")) ## *** add each n as text above bar
whyNot
```

***

### s2. Comparison with other studies:

> Are these results similar to other data recovery efforts?

This is one of four studies I found that look at the ability to recover data that is supposed to be publicly available.

```{r comparison data, echo=FALSE}

comp=data.frame(study=c('SavageVickers2009','WichertsEtAl2006','Wolins1962','evostcProject2012'),
                n=c(10,249,37,406),
                successRate=c(0.10,0.26,0.24,0.32))
comp

stComparison<-ggplot(comp,aes(x=study,y=successRate))+
  geom_bar(stat = "identity")+
  theme(axis.line=element_line('black'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(axis.text.x = element_text(angle=90))+
  xlab('\nStudy')+
  ylim(0,0.5)+
  ylab('Percent successful\n')+
  ggtitle('Success rates from four data recovery studies')+
  theme(axis.text=element_text(size=14),
        title=element_text(size=16,face="bold"))+
  theme(axis.line.x = element_line(color="black"),
        axis.line.y = element_line(color="black"))+
  annotate("text",x=1,y=comp$successRate[4]+0.05,label=as.character(comp$n[4]))+
  annotate("text",x=2,y=comp$successRate[1]+0.05,label=as.character(comp$n[1]))+
  annotate("text",x=3,y=comp$successRate[2]+0.05,label=as.character(comp$n[2]))+
  annotate("text",x=4,y=comp$successRate[3]+0.05,label=as.character(comp$n[3]))
stComparison
```

_Note: We have reinvigorated these efforts for one last year and I plan to add the added progress from the latest recovery efforts to the discussion section._